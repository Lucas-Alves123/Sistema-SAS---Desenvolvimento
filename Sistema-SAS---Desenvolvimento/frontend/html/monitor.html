<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor - SAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="app"></div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/layout.js"></script>

    <script>
        const user = window.SAS.utils.checkAuth();
        window.SAS.layout.renderLayout('Monitor');

        const content = document.getElementById('page-content');

        content.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 animate-fade-in">
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-3">
                        <i data-lucide="monitor" class="w-8 h-8 text-blue-700"></i>
                        <h1 class="text-3xl font-bold text-blue-700">Monitor de Atendimentos</h1>
                    </div>
                    <!-- Decorative Line (Pernambuco Colors) -->
                    <div class="h-1.5 w-32 bg-gradient-to-r from-blue-600 via-yellow-400 to-red-500 rounded-full"></div>
                </div>

                <div class="flex items-center gap-2 bg-white p-2 rounded-lg shadow-sm border">
                    <span class="text-sm text-gray-600">Filtrar por:</span>
                    <select id="attendantFilter" class="border-none bg-transparent font-medium text-blue-700 focus:ring-0 cursor-pointer">
                        <option value="all">Todos os Atendentes</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Status Cards -->
                <div class="space-y-4">
                    ${renderStatusCard('Agendados', 'clock', 'blue', 'agendado')}
                    ${renderStatusCard('Aguardando', 'clock', 'yellow', 'chegou')}
                    ${renderStatusCard('Pendentes', 'alert-circle', 'orange', 'pendente')}
                    ${renderStatusCard('Em Andamento', 'play', 'blue', 'em_andamento')}
                    ${renderStatusCard('Concluídos', 'check-circle', 'green', 'concluido')}
                    ${renderStatusCard('Cancelados', 'x-circle', 'red', 'cancelado')}
                </div>

                <!-- Table -->
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-gray-800">Todos os Atendimentos</h3>
                            <button id="refreshBtn" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full transition-colors">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-600 font-medium border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-3">Nome</th>
                                        <th class="px-4 py-3">Data/Hora</th>
                                        <th class="px-4 py-3">Serviço</th>
                                        <th class="px-4 py-3">Atendente</th>
                                        <th class="px-4 py-3">Guichê</th>
                                        <th class="px-4 py-3">Status</th>
                                        <th class="px-4 py-3">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody" class="divide-y divide-slate-100">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;

        function renderStatusCard(label, icon, color, statusKey) {
            return `
                <div class="bg-white border-l-4 border-${color}-400 rounded-lg p-4 shadow-sm flex items-center gap-3">
                    <div class="p-2 bg-${color}-50 rounded-full text-${color}-600">
                        <i data-lucide="${icon}" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <div id="count-${statusKey}" class="text-2xl font-bold text-${color}-600">0</div>
                        <div class="text-sm text-gray-600">${label}</div>
                    </div>
                </div>
            `;
        }

        lucide.createIcons();

        // Logic
        const attendantFilter = document.getElementById('attendantFilter');
        const refreshBtn = document.getElementById('refreshBtn');
        const tableBody = document.getElementById('tableBody');

        // Filter Logic
        if (attendantFilter) {
            attendantFilter.addEventListener('change', () => loadData());
        }

        const loadData = async () => {
            if (attendantFilter && attendantFilter.options.length === 1) {
                const users = await window.SAS.base44.entities.SystemUser.list();
                users.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.id;
                    option.textContent = u.usuario;
                    attendantFilter.appendChild(option);
                });
            }
            let atendimentos = await window.SAS.base44.entities.Agendamento.list('-created_date');

            if (attendantFilter && attendantFilter.value !== 'all') {
                atendimentos = atendimentos.filter(a => a.atendente_id === attendantFilter.value);
            }

            const counts = {
                agendado: 0, chegou: 0, pendente: 0, em_andamento: 0, concluido: 0, cancelado: 0
            };

            atendimentos.forEach(a => {
                if (counts[a.status] !== undefined) counts[a.status]++;
                else if (a.status === 'nao_compareceu') counts.cancelado++;
            });

            Object.keys(counts).forEach(key => {
                const el = document.getElementById(`count-${key}`);
                if (el) el.textContent = counts[key];
            });

            tableBody.innerHTML = '';
            if (atendimentos.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Nenhum registro encontrado.</td></tr>';
            } else {
                atendimentos.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 transition-colors';

                    let statusColor = 'bg-gray-100 text-gray-800';
                    if (item.status === 'concluido') statusColor = 'bg-green-100 text-green-800';
                    else if (item.status === 'em_andamento') statusColor = 'bg-blue-100 text-blue-800';
                    else if (item.status === 'pendente') statusColor = 'bg-orange-100 text-orange-800';
                    else if (item.status === 'cancelado' || item.status === 'nao_compareceu') statusColor = 'bg-red-100 text-red-800';

                    let actionBtn = '';
                    if (item.status === 'concluido' || item.status === 'cancelado' || item.status === 'nao_compareceu') {
                        actionBtn = `
                            <button onclick="openDetailsModal('${item.id}')" class="text-blue-600 hover:bg-blue-100 p-1.5 rounded-lg transition-colors" title="Ver Detalhes">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                            </button>
                        `;
                    }

                    tr.innerHTML = `
                        <td class="px-4 py-3 font-medium text-gray-900">${item.nome_completo}</td>
                        <td class="px-4 py-3 text-gray-600">${window.SAS.utils.formatDate(item.data_agendamento)} ${item.hora_inicio || '-'}</td>
                        <td class="px-4 py-3 text-gray-600">${item.tipo_servico}</td>
                        <td class="px-4 py-3 text-gray-600">${item.atendente_nome || '-'}</td>
                        <td class="px-4 py-3 text-gray-600">${item.guiche || '-'}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor} capitalize">
                                ${item.status.replace('_', ' ')}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            ${actionBtn}
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
                lucide.createIcons();
            }
        };

        window.openDetailsModal = async (id) => {
            try {
                const all = await window.SAS.base44.entities.Agendamento.list();
                const item = all.find(a => a.id == id);

                if (!item) return;

                const html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-1">Cliente</label>
                            <div class="text-lg text-gray-800 font-medium">${item.nome_completo}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-1">Serviço</label>
                            <div class="text-lg text-gray-800 font-medium">${item.tipo_servico}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-1">Atendente</label>
                            <div class="text-lg text-gray-800 font-medium">${item.atendente_nome || '-'}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-1">Data/Hora</label>
                            <div class="text-lg text-gray-800 font-medium">${window.SAS.utils.formatDate(item.data_agendamento)} ${item.hora_inicio || '-'}</div>
                        </div>
                    </div>

                    <div class="space-y-4 bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <div>
                            <label class="block text-sm font-bold text-blue-700 uppercase mb-2">Observação 1 - Problema</label>
                            <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${item.observacao_problema || 'Nenhuma observação registrada.'}</p>
                        </div>
                        <div class="border-t border-slate-200 my-4"></div>
                        <div>
                            <label class="block text-sm font-bold text-green-700 uppercase mb-2">Observação 2 - Solução</label>
                            <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${item.observacao_solucao || 'Nenhuma solução registrada.'}</p>
                        </div>
                    </div>
                `;

                window.SAS.utils.modal.alert('Detalhes do Atendimento', html, 'info');
            } catch (e) {
                console.error('Error opening modal:', e);
                window.SAS.utils.modal.alert('Erro', 'Erro ao carregar detalhes.', 'danger');
            }
        };

        window.deleteItem = async (id) => {
            window.SAS.utils.modal.confirm('Excluir Registro', 'Tem certeza que deseja excluir este registro permanentemente?', async () => {
                await window.SAS.base44.entities.Agendamento.delete(id);
                loadData();
                window.SAS.utils.notify('success', 'Registro excluído!');
            }, 'danger');
        };

        refreshBtn.addEventListener('click', () => {
            refreshBtn.classList.add('animate-spin');
            loadData().then(() => setTimeout(() => refreshBtn.classList.remove('animate-spin'), 500));
        });

        loadData();
    </script>
</body>

</html>