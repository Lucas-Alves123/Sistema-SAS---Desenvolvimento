<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimento WhatsApp - SAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sonner@1.4.0/dist/sonner.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4 font-sans">

    <!-- Header / Disclaimer -->
    <div class="w-full max-w-2xl bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6 fade-in">
        <div class="flex items-center gap-3 mb-4 border-b border-slate-100 pb-4">
            <i data-lucide="message-circle" class="w-8 h-8 text-green-600"></i>
            <div>
                <h1 class="text-xl font-bold text-slate-800">Atendimento ao Servidor - SES</h1>
                <p class="text-sm text-slate-500">Canal exclusivo via WhatsApp</p>
            </div>
        </div>

        <div class="space-y-4 text-sm text-slate-600">
            <p class="font-medium text-slate-800">Boa tarde!</p>
            <p>Este canal √© destinado ao Atendimento ao Servidor da Secretaria Estadual de Sa√∫de (SES).</p>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex gap-3 items-start">
                <i data-lucide="phone-off" class="w-5 h-5 text-yellow-600 shrink-0 mt-0.5"></i>
                <p>N√£o realizamos liga√ß√µes e n√£o √© poss√≠vel ouvir √°udios enviados por este canal. Caso precise falar por
                    telefone, entre em contato diretamente com nossa central.</p>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex gap-3 items-start">
                <i data-lucide="message-square-warning" class="w-5 h-5 text-blue-600 shrink-0 mt-0.5"></i>
                <p>Evite o envio repetido de mensagens. Cada nova mensagem faz sua solicita√ß√£o retornar ao fim da fila,
                    o que pode atrasar o atendimento.</p>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="mainContent" class="w-full max-w-2xl fade-in">
        <!-- Flow 1: Identification Form -->
        <div id="step1" class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
            <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="user-check" class="w-5 h-5 text-blue-600"></i>
                Identifica√ß√£o
            </h2>
            <p class="text-sm text-slate-600 mb-6">Para registrar seu atendimento, preencha os dados abaixo referentes
                ao v√≠nculo com a SES:</p>

            <form id="identificationForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nome Completo *</label>
                    <input type="text" name="nome_completo" required
                        class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none transition-all"
                        placeholder="Digite seu nome completo">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">CPF *</label>
                        <input type="text" name="cpf" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none transition-all"
                            placeholder="000.000.000-00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Matr√≠cula *</label>
                        <input type="text" name="matricula" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none transition-all"
                            placeholder="Digite sua matr√≠cula">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Cargo *</label>
                        <input type="text" name="cargo" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none transition-all"
                            placeholder="Ex: Enfermeiro">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">V√≠nculo *</label>
                        <select name="vinculo" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none bg-white">
                            <option value="">Selecione...</option>
                            <option value="Efetivo">Efetivo</option>
                            <option value="Comissionado">Comissionado</option>
                            <option value="Contratado">Contratado</option>
                            <option value="Cedido">Cedido</option>
                            <option value="Aposentado">Aposentado</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Local de Trabalho *</label>
                    <input type="text" name="local_trabalho" required
                        class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none transition-all"
                        placeholder="Ex: Hospital da Restaura√ß√£o">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">E-mail *</label>
                    <input type="email" name="email" required
                        class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none transition-all"
                        placeholder="seu@email.com">
                </div>

                <!-- Hidden field for service type, defaulting to 'Atendimento WhatsApp' -->
                <input type="hidden" name="tipo_servico" value="Atendimento WhatsApp">

                <button type="submit" id="submitBtn" disabled
                    class="w-full bg-slate-300 text-slate-500 font-bold py-3 rounded-lg transition-all mt-6 cursor-not-allowed flex justify-center items-center gap-2">
                    Entrar na Fila
                </button>
            </form>
        </div>

        <!-- Flow 2: Queue Status -->
        <div id="step2" class="hidden bg-white rounded-xl shadow-lg border border-slate-200 p-8 text-center">
            <div class="mb-6 flex justify-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center animate-pulse">
                    <i data-lucide="clock" class="w-10 h-10 text-green-600"></i>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-slate-800 mb-2">Seus dados foram registrados com sucesso!</h2>
            <p class="text-slate-600 mb-8">Voc√™ entrou na fila de atendimento.</p>

            <div class="bg-slate-50 rounded-xl p-6 border border-slate-200 mb-8 inline-block w-full max-w-sm">
                <div class="text-sm text-slate-500 uppercase font-bold tracking-wider mb-1">Posi√ß√£o Atual</div>
                <div class="text-5xl font-bold text-blue-600" id="queuePosition">--</div>
                <p class="text-xs text-slate-400 mt-2">Aguarde. Sua posi√ß√£o ser√° atualizada automaticamente.</p>
            </div>

            <div class="text-left bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800">
                <p class="font-bold mb-2 flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4"></i>
                    Regras da Fila:
                </p>
                <ul class="list-disc list-inside space-y-1 opacity-90">
                    <li>Cada novo cadastro entra no final da fila.</li>
                    <li>A fila √© atualizada em tempo real.</li>
                    <li>O acesso ao WhatsApp ser√° liberado quando chegar sua vez.</li>
                </ul>
            </div>
        </div>

        <!-- Flow 3: Release / Ready -->
        <div id="step3"
            class="hidden bg-white rounded-xl shadow-lg border border-green-500 p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-green-600"></div>

            <div class="mb-6 flex justify-center">
                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center animate-bounce">
                    <i data-lucide="party-popper" class="w-12 h-12 text-green-600"></i>
                </div>
            </div>

            <h2 class="text-3xl font-bold text-slate-800 mb-2">Chegou a sua vez!</h2>
            <p class="text-slate-600 mb-8">Um atendente est√° pronto para falar com voc√™.</p>

            <div class="text-left bg-slate-50 p-5 rounded-lg border border-slate-200 mb-8">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-slate-500"></i>
                    Informa√ß√µes Importantes
                </h3>
                <p class="text-sm text-slate-600 mb-4">Quando aplic√°vel, tenha em m√£os os seguintes documentos:</p>
                <ul class="list-disc list-inside text-sm text-slate-600 space-y-1 mb-4 pl-2">
                    <li>Procura√ß√£o</li>
                    <li>Documento oficial com foto do outorgante</li>
                    <li>Documento oficial com foto do procurador</li>
                </ul>

                <div class="border-t border-slate-200 pt-4">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Qual sua demanda?</label>
                    <p class="text-xs text-slate-500 mb-2">Descreva de forma clara e objetiva para agilizar seu
                        atendimento.</p>
                    <textarea id="demandaInput"
                        class="w-full border border-slate-300 rounded-lg p-3 h-24 focus:ring-2 focus:ring-green-500 outline-none resize-none"
                        placeholder="Digite aqui..."></textarea>
                </div>
            </div>

            <a id="whatsappLink" href="#" target="_blank"
                class="block w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-green-200 transition-all flex items-center justify-center gap-3 transform hover:scale-[1.02]">
                <i data-lucide="message-circle" class="w-6 h-6"></i>
                Iniciar Atendimento no WhatsApp
            </a>

            <p class="text-xs text-slate-400 mt-6">
                O WhatsApp √© apenas o canal final. A fila √© gerenciada pelo sistema.
            </p>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const form = document.getElementById('identificationForm');
        const submitBtn = document.getElementById('submitBtn');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const queuePositionEl = document.getElementById('queuePosition');
        const whatsappLink = document.getElementById('whatsappLink');
        const demandaInput = document.getElementById('demandaInput');

        let currentId = localStorage.getItem('sas_whatsapp_id');
        let pollInterval = null;
        let userData = JSON.parse(localStorage.getItem('sas_whatsapp_user') || '{}');

        // If we have a session, resume
        if (currentId) {
            const lastStep = localStorage.getItem('sas_whatsapp_step') || '2';
            showStep(parseInt(lastStep));
            if (lastStep === '2') startPolling();
        }

        // Form Validation
        form.addEventListener('input', () => {
            const isValid = form.checkValidity();
            if (isValid) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
                submitBtn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700', 'shadow-lg');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700', 'shadow-lg');
            }
        });

        // Submit Handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            userData = Object.fromEntries(formData.entries());

            submitBtn.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i> Processando...';
            submitBtn.disabled = true;
            lucide.createIcons();

            try {
                const response = await fetch('/api/agendamentos/public', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro ao registrar.');
                }

                currentId = result.id;
                localStorage.setItem('sas_whatsapp_id', currentId);
                localStorage.setItem('sas_whatsapp_user', JSON.stringify(userData));
                localStorage.setItem('sas_whatsapp_step', '2');
                showStep(2);
                startPolling();

            } catch (error) {
                alert(error.message);
                submitBtn.innerHTML = 'Entrar na Fila';
                submitBtn.disabled = false;
            }
        });

        function showStep(step) {
            step1.classList.add('hidden');
            step2.classList.add('hidden');
            step3.classList.add('hidden');

            if (step === 1) step1.classList.remove('hidden');
            if (step === 2) step2.classList.remove('hidden');
            if (step === 3) {
                step3.classList.remove('hidden');
                updateWhatsappLink();
            }
            localStorage.setItem('sas_whatsapp_step', step.toString());
            lucide.createIcons();
        }

        function updateWhatsappLink() {
            const demanda = demandaInput.value.trim();

            const message = `Boa tarde! üëã
Seu atendimento foi liberado pela Secretaria Estadual de Sa√∫de (SES).

Segue abaixo a confirma√ß√£o dos dados informados no cadastro:

Nome: ${userData.nome_completo}
CPF: ${userData.cpf}
Matr√≠cula: ${userData.matricula}
Cargo: ${userData.cargo}
V√≠nculo: ${userData.vinculo}
Local de trabalho: ${userData.local_trabalho}
E-mail: ${userData.email}

üìé Quando aplic√°vel, encaminhe tamb√©m:
Procura√ß√£o;
Documento oficial com foto do outorgante;
Documento oficial com foto do procurador.

‚ùì Qual √© a sua demanda?
${demanda ? demanda : '(Descreva sua demanda aqui...)'}

üôè Agradecemos a compreens√£o e a colabora√ß√£o.`;

            const encodedMessage = encodeURIComponent(message);
            whatsappLink.href = `https://wa.me/558131840058?text=${encodedMessage}`;
        }

        demandaInput.addEventListener('input', updateWhatsappLink);

        function startPolling() {
            checkStatus(); // Immediate check
            pollInterval = setInterval(checkStatus, 5000); // Poll every 5s
        }

        async function checkStatus() {
            if (!currentId) return;

            try {
                const response = await fetch(`/api/agendamentos/public/status/${currentId}`);
                const data = await response.json();

                if (data.status === 'chegou') {
                    queuePositionEl.textContent = data.position;
                } else if (data.status === 'pendente' || data.status === 'em_andamento') {
                    clearInterval(pollInterval);
                    showStep(3);
                } else {
                    // Cancelled or other
                    clearInterval(pollInterval);
                    alert(data.message || 'Seu atendimento foi encerrado.');
                    localStorage.removeItem('sas_whatsapp_id');
                    localStorage.removeItem('sas_whatsapp_user');
                    localStorage.removeItem('sas_whatsapp_step');
                    location.reload();
                }

            } catch (e) {
                console.error('Polling error', e);
            }
        }
    </script>
</body>

</html>