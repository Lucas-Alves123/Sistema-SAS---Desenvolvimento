<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - SAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sonner@1.4.0/dist/sonner.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div id="app"></div>

    <!-- Scripts -->
    <script src="js/utils.js?v=5"></script>
    <script src="js/api.js?v=5"></script>
    <script src="js/layout.js?v=5"></script>

    <script>
        const user = window.SAS.utils.checkAuth();
        window.SAS.layout.renderLayout('Agendamento');

        const content = document.getElementById('page-content');

        content.innerHTML = `
            <div class="flex flex-col items-center justify-center mb-8 animate-fade-in">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="calendar" class="w-8 h-8 text-blue-700"></i>
                    <h1 class="text-3xl font-bold text-blue-700">Agendamento</h1>
                </div>
                <!-- Decorative Line (Pernambuco Colors) -->
                <div class="flex justify-center items-center">
                    <div class="h-1.5 w-32 bg-gradient-to-r from-blue-600 via-yellow-400 to-red-500 rounded-full"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 border-t-4 border-t-blue-600 p-8 max-w-6xl mx-auto">
                <form id="agendamentoForm" class="space-y-6">
                    
                    <!-- Row 1 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Nome completo <span class="text-red-500">*</span></label>
                            <input type="text" id="nome" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="Ex.: Maria Silva" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">CPF</label>
                            <input type="text" id="cpf" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="000.000.000-00" maxlength="14">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Matrícula</label>
                            <input type="text" id="matricula" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="Apenas números">
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Cargo</label>
                            <input type="text" id="cargo" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="Ex.: Analista Administrativo">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Tipo de vínculo</label>
                            <select id="vinculo" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600">
                                <option value="">Selecione...</option>
                                <option value="Efetivo">Efetivo</option>
                                <option value="Comissionado">Comissionado</option>
                                <option value="Temporário">Temporário</option>
                                <option value="Estagiário">Estagiário</option>
                                <option value="Jovem Aprendiz">Jovem Aprendiz</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Local de trabalho</label>
                            <input type="text" id="local_trabalho" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="Ex.: Sede - Boa Vista">
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">E-mail</label>
                            <input type="email" id="email" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="seuemail@dominio.pe.gov.br">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Tipo de serviço <span class="text-red-500">*</span></label>
                            <select id="servico" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600" required>
                                <option value="">Selecione...</option>
                                <option value="Aposentadoria">Aposentadoria</option>
                                <option value="Atendimento Geral">Atendimento Geral</option>
                                <option value="Seleção Pública Simplificada">Seleção Pública Simplificada</option>
                                <option value="Certidão">Certidão</option>
                                <option value="Licença">Licença</option>
                                <option value="Pagamento">Pagamento</option>
                                <option value="Plantão Extraordinário">Plantão Extraordinário</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Tipo de atendimento</label>
                            <select id="tipo_atendimento" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600">
                                <option value="">Selecione...</option>
                                <option value="Presencial">Presencial</option>
                                <option value="Online">Online</option>
                                <option value="Telefônico">Telefônico</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 4 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Prioridade</label>
                            <select id="prioridade" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600">
                                <option value="Normal">Normal</option>
                                <option value="Urgente">Urgente</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Data do agendamento <span class="text-red-500">*</span></label>
                            <input type="date" id="data" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-600" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Hora de inicio</label>
                            <select id="hora" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600">
                                <option value="">--:--</option>
                            </select>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <button type="button" id="exportBtn" class="w-full md:w-auto px-6 py-2.5 border-2 border-blue-600 text-blue-600 rounded-lg font-bold hover:bg-blue-50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            Exportar XLS
                        </button>

                        <button type="submit" class="w-full md:w-auto px-12 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg hover:shadow-blue-200 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="check" class="w-5 h-5"></i>
                            Confirmar Agendamento
                        </button>

                        <button type="button" id="clearBtn" class="w-full md:w-auto px-6 py-2.5 border border-gray-300 text-gray-600 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                            Limpar Campos
                        </button>
                    </div>
                </form>
            </div>
            <!-- Generic Modal -->
            <!-- Styled Modal -->
            <div id="genericModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
                    <div class="p-6">
                        <div class="flex items-start gap-4">
                            <div id="modalIconContainer" class="bg-blue-100 p-3 rounded-full shrink-0">
                                <i id="modalIcon" data-lucide="info" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div>
                                <h3 id="modalTitle" class="text-lg font-bold text-slate-800 mb-2">Atenção</h3>
                                <p id="modalMessage" class="text-slate-600">Mensagem aqui...</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 flex justify-end gap-3">
                        <button id="modalCancelBtn" class="bg-white border border-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-50 transition-colors hidden">
                            Cancelar
                        </button>
                        <button id="modalConfirmBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg shadow-blue-200">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        `;

        lucide.createIcons();

        // Logic
        const form = document.getElementById('agendamentoForm');
        const dataInput = document.getElementById('data');
        const horaSelect = document.getElementById('hora');
        const cpfInput = document.getElementById('cpf');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');

        // Modal Elements
        const genericModal = document.getElementById('genericModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const modalIconContainer = document.getElementById('modalIconContainer');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        let onModalConfirm = null;

        window.openModal = (title, message, type = 'info', showCancel = false, onConfirm = null) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            onModalConfirm = onConfirm;

            if (showCancel) {
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.textContent = 'Confirmar';
            } else {
                modalCancelBtn.classList.add('hidden');
                modalConfirmBtn.textContent = 'OK';
            }

            // Style based on type
            if (type === 'error') {
                modalIconContainer.className = 'bg-red-100 p-3 rounded-full shrink-0';
                modalIcon.className = 'w-6 h-6 text-red-600';
                modalIcon.setAttribute('data-lucide', 'alert-circle');
                modalConfirmBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg shadow-red-200';
            } else if (type === 'success') {
                modalIconContainer.className = 'bg-green-100 p-3 rounded-full shrink-0';
                modalIcon.className = 'w-6 h-6 text-green-600';
                modalIcon.setAttribute('data-lucide', 'check');
                modalConfirmBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg shadow-green-200';
            } else {
                modalIconContainer.className = 'bg-blue-100 p-3 rounded-full shrink-0';
                modalIcon.className = 'w-6 h-6 text-blue-600';
                modalIcon.setAttribute('data-lucide', 'info');
                modalConfirmBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg shadow-blue-200';
            }
            
            lucide.createIcons();
            genericModal.classList.remove('hidden');
        };
        window.closeModal = () => {
            genericModal.classList.add('hidden');
            onModalConfirm = null;
        };

        modalConfirmBtn.addEventListener('click', () => {
            if (onModalConfirm) onModalConfirm();
            closeModal();
        });

        modalCancelBtn.addEventListener('click', () => {
            closeModal();
        });

        // CPF Mask
        cpfInput.addEventListener('input', (e) => {
            e.target.value = window.SAS.utils.formatCPF(e.target.value);
        });

        // Date Logic
        const today = new Date().toISOString().split('T')[0];
        dataInput.min = today;

        const updateTimeSlots = () => {
            const dateValue = dataInput.value;

            // Default: Populate slots
            const populateSlots = () => {
                // Save current selection if any
                const currentSelection = horaSelect.value;

                horaSelect.innerHTML = '<option value="">--:--</option>';
                const startTime = 8 * 60; // 08:00
                const endTime = 16 * 60 + 45; // 16:45

                for (let time = startTime; time <= endTime; time += 15) {
                    const hours = Math.floor(time / 60);
                    const minutes = time % 60;
                    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

                    const opt = document.createElement('option');
                    opt.value = timeString;
                    opt.textContent = timeString;
                    horaSelect.appendChild(opt);
                }

                // Restore selection if valid
                if (currentSelection) {
                    horaSelect.value = currentSelection;
                }
            };

            if (!dateValue) {
                // If no date, still show slots (generic)
                populateSlots();
                return;
            }

            const [year, month, day] = dateValue.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday

            if (dayOfWeek === 0 || dayOfWeek === 6) {
                openModal('Fim de Semana', 'Agendamentos não podem ser realizados aos finais de semana.', 'info');
                dataInput.value = ''; // Silently clear the value
                horaSelect.innerHTML = '<option value="">--:--</option>';
                return;
            }

            populateSlots();
        };

        dataInput.addEventListener('input', updateTimeSlots);
        dataInput.addEventListener('change', updateTimeSlots);

        // Initialize on load
        updateTimeSlots();

        // Clear Fields
        clearBtn.addEventListener('click', () => {
            openModal('Limpar Campos', 'Deseja limpar todos os campos?', 'info', true, () => {
                form.reset();
                updateTimeSlots(); // Reset slots
            });
        });

        // Export XLS Logic
        exportBtn.addEventListener('click', async () => {
            try {
                const agendamentos = await window.SAS.base44.entities.Agendamento.list();

                if (agendamentos.length === 0) {
                    openModal('Exportar', 'Não há agendamentos para exportar.', 'info');
                    return;
                }

                // Format data for Excel
                const dataToExport = agendamentos.map(a => ({
                    'Nome Completo': a.nome_completo,
                    'CPF': a.cpf,
                    'Matrícula': a.matricula,
                    'Cargo': a.cargo,
                    'Vínculo': a.vinculo,
                    'Local de Trabalho': a.local_trabalho,
                    'E-mail': a.email,
                    'Serviço': a.tipo_servico,
                    'Atendimento': a.tipo_atendimento,
                    'Prioridade': a.prioridade,
                    'Data': a.data_agendamento,
                    'Hora': a.hora_inicio,
                    'Status': a.status
                }));

                // Create Worksheet
                const ws = XLSX.utils.json_to_sheet(dataToExport);

                // Create Workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");

                // Generate Excel file as binary string
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

                // Create Blob
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Agendamentos_SAS.xlsx";
                document.body.appendChild(a);
                a.click();

                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (err) {
                console.error(err);
                openModal('Erro', 'Erro ao exportar dados: ' + err.message, 'error');
            }
        });
        // Submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = {
                nome_completo: document.getElementById('nome').value,
                cpf: document.getElementById('cpf').value,
                matricula: document.getElementById('matricula').value,
                cargo: document.getElementById('cargo').value,
                vinculo: document.getElementById('vinculo').value,
                local_trabalho: document.getElementById('local_trabalho').value,
                email: document.getElementById('email').value,
                tipo_servico: document.getElementById('servico').value,
                tipo_atendimento: document.getElementById('tipo_atendimento').value,
                prioridade: document.getElementById('prioridade').value,
                data_agendamento: document.getElementById('data').value,
                hora_inicio: document.getElementById('hora').value || null,
                status: 'agendado',
                created_by: user.id
            };


            // Validation: Past Time
            if (payload.hora_inicio) {
                const now = new Date();
                const [year, month, day] = payload.data_agendamento.split('-').map(Number);
                const [hours, minutes] = payload.hora_inicio.split(':').map(Number);
                const selectedDate = new Date(year, month - 1, day, hours, minutes);

                if (selectedDate < now) {
                    openModal('Horário Inválido', 'Não é possível realizar agendamentos para horários que já passaram.', 'error');
                    return;
                }
            }
            const submitAppointment = async (data) => {
                try {
                    await window.SAS.base44.entities.Agendamento.create(data);
                    if (window.toast) {
                        window.toast.success('Agendamento realizado com sucesso!');
                    } else {
                        openModal('Sucesso', 'Agendamento realizado com sucesso!', 'success');
                    }
                    form.reset();
                    updateTimeSlots(); // Reset slots
                } catch (err) {
                    console.error('Submit Error:', err);

                    // Check for attached data from api.js
                    const errorData = err.data || {};
                    const errorMessage = err.message || '';

                    // Handle Duplicate Appointment
                    if (errorData.code === 'DUPLICATE_APPOINTMENT' || errorMessage.includes('Duplicate appointment')) {
                        openModal('Agendamento Duplicado', 'Já existe um agendamento para este servidor nesta data. Deseja agendar mesmo assim?', 'info', true, async () => {
                            data.force_duplicate = true;
                            await submitAppointment(data);
                        });
                    }
                    // Handle Slot Conflict
                    else if (errorData.code === 'SLOT_CONFLICT' || errorMessage.includes('Slot conflict')) {
                        openModal('Horário Ocupado', 'Este horário já está ocupado. Por favor, escolha outro horário.', 'error');
                    }
                    // Generic Error
                    else {
                        openModal('Erro', 'Erro ao realizar agendamento: ' + errorMessage, 'error');
                    }
                }
            };

            await submitAppointment(payload);
        });
    </script>
</body>

</html>