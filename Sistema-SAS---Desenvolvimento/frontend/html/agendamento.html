<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - SAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sonner@1.4.0/dist/sonner.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div id="app"></div>

    <!-- Scripts -->
    <script src="js/utils.js?v=5"></script>
    <script src="js/api.js?v=5"></script>
    <script src="js/layout.js?v=5"></script>

    <script>
        const user = window.SAS.utils.checkAuth();
        window.SAS.layout.renderLayout('Agendamento');

        const content = document.getElementById('page-content');

        content.innerHTML = `
            <div class="flex flex-col items-center justify-center mb-8 animate-fade-in">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="calendar" class="w-8 h-8 text-blue-700"></i>
                    <h1 class="text-3xl font-bold text-blue-700">Agendamento</h1>
                </div>
                <!-- Decorative Line (Pernambuco Colors) -->
                <div class="flex justify-center items-center">
                    <div class="h-1.5 w-32 bg-gradient-to-r from-blue-600 via-yellow-400 to-red-500 rounded-full"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 border-t-4 border-t-blue-600 p-8 max-w-6xl mx-auto">
                <form id="agendamentoForm" class="space-y-6">
                    
                    <!-- Row 1 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Nome completo <span class="text-red-500">*</span></label>
                            <input type="text" id="nome" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="Ex.: Maria Silva" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">CPF</label>
                            <input type="text" id="cpf" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="000.000.000-00" maxlength="14">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Matrícula</label>
                            <input type="text" id="matricula" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="Apenas números">
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Cargo</label>
                            <input type="text" id="cargo" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="Ex.: Analista Administrativo">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Tipo de vínculo</label>
                            <select id="vinculo" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600">
                                <option value="">Selecione...</option>
                                <option value="Efetivo">Efetivo</option>
                                <option value="Comissionado">Comissionado</option>
                                <option value="Temporário">Temporário</option>
                                <option value="Estagiário">Estagiário</option>
                                <option value="Jovem Aprendiz">Jovem Aprendiz</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Local de trabalho</label>
                            <input type="text" id="local_trabalho" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="Ex.: Sede - Boa Vista">
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">E-mail</label>
                            <input type="email" id="email" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="seuemail@dominio.pe.gov.br">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Tipo de serviço <span class="text-red-500">*</span></label>
                            <select id="servico" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600" required>
                                <option value="">Selecione...</option>
                                <option value="Aposentadoria">Aposentadoria</option>
                                <option value="Atendimento Geral">Atendimento Geral</option>
                                <option value="Seleção Pública Simplificada">Seleção Pública Simplificada</option>
                                <option value="Certidão">Certidão</option>
                                <option value="Licença">Licença</option>
                                <option value="Pagamento">Pagamento</option>
                                <option value="Plantão Extraordinário">Plantão Extraordinário</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Tipo de atendimento</label>
                            <select id="tipo_atendimento" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600">
                                <option value="">Selecione...</option>
                                <option value="Presencial">Presencial</option>
                                <option value="Online">Online</option>
                                <option value="Telefônico">Telefônico</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 4 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Prioridade</label>
                            <select id="prioridade" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600">
                                <option value="Normal">Normal</option>
                                <option value="Urgente">Urgente</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Data do agendamento <span class="text-red-500">*</span></label>
                            <input type="date" id="data" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-600" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-semibold text-gray-700">Hora de inicio</label>
                            <select id="hora" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-gray-600">
                                <option value="">--:--</option>
                            </select>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <button type="button" id="exportBtn" class="w-full md:w-auto px-6 py-2.5 border-2 border-blue-600 text-blue-600 rounded-lg font-bold hover:bg-blue-50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            Exportar XLS
                        </button>

                        <button type="submit" class="w-full md:w-auto px-12 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg hover:shadow-blue-200 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="check" class="w-5 h-5"></i>
                            Confirmar Agendamento
                        </button>

                        <button type="button" id="clearBtn" class="w-full md:w-auto px-6 py-2.5 border border-gray-300 text-gray-600 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                            Limpar Campos
                        </button>
                    </div>
                </form>
            </div>
        `;

        lucide.createIcons();

        // Logic
        const form = document.getElementById('agendamentoForm');
        const dataInput = document.getElementById('data');
        const horaSelect = document.getElementById('hora');
        const cpfInput = document.getElementById('cpf');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');

        // CPF Mask
        cpfInput.addEventListener('input', (e) => {
            e.target.value = window.SAS.utils.formatCPF(e.target.value);
        });

        // Date Logic
        const today = new Date().toISOString().split('T')[0];
        dataInput.min = today;

        const updateTimeSlots = () => {
            const dateValue = dataInput.value;

            const populateSlots = () => {
                const currentSelection = horaSelect.value;
                horaSelect.innerHTML = '<option value="">--:--</option>';
                const startTime = 8 * 60; // 08:00
                const endTime = 16 * 60 + 45; // 16:45

                for (let time = startTime; time <= endTime; time += 15) {
                    const hours = Math.floor(time / 60);
                    const minutes = time % 60;
                    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

                    const opt = document.createElement('option');
                    opt.value = timeString;
                    opt.textContent = timeString;
                    horaSelect.appendChild(opt);
                }

                if (currentSelection) {
                    horaSelect.value = currentSelection;
                }
            };

            if (!dateValue) {
                populateSlots();
                return;
            }

            const [year, month, day] = dateValue.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();

            if (dayOfWeek === 0 || dayOfWeek === 6) {
                window.SAS.utils.modal.alert('Fim de Semana', 'Agendamentos não podem ser realizados aos finais de semana.', 'info');
                dataInput.value = '';
                horaSelect.innerHTML = '<option value="">--:--</option>';
                return;
            }

            populateSlots();
        };

        dataInput.addEventListener('input', updateTimeSlots);
        dataInput.addEventListener('change', updateTimeSlots);

        updateTimeSlots();

        clearBtn.addEventListener('click', () => {
            window.SAS.utils.modal.confirm('Limpar Campos', 'Deseja limpar todos os campos?', () => {
                form.reset();
                updateTimeSlots();
            });
        });

        exportBtn.addEventListener('click', async () => {
            try {
                const agendamentos = await window.SAS.base44.entities.Agendamento.list();

                if (agendamentos.length === 0) {
                    window.SAS.utils.modal.alert('Exportar', 'Não há agendamentos para exportar.', 'info');
                    return;
                }

                const dataToExport = agendamentos.map(a => ({
                    'Nome Completo': a.nome_completo,
                    'CPF': a.cpf,
                    'Matrícula': a.matricula,
                    'Cargo': a.cargo,
                    'Vínculo': a.vinculo,
                    'Local de Trabalho': a.local_trabalho,
                    'E-mail': a.email,
                    'Serviço': a.tipo_servico,
                    'Atendimento': a.tipo_atendimento,
                    'Prioridade': a.prioridade,
                    'Data': a.data_agendamento,
                    'Hora': a.hora_inicio,
                    'Status': a.status
                }));

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Agendamentos_SAS.xlsx";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (err) {
                console.error(err);
                window.SAS.utils.modal.alert('Erro', 'Erro ao exportar dados: ' + err.message, 'danger');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = {
                nome_completo: document.getElementById('nome').value,
                cpf: document.getElementById('cpf').value,
                matricula: document.getElementById('matricula').value,
                cargo: document.getElementById('cargo').value,
                vinculo: document.getElementById('vinculo').value,
                local_trabalho: document.getElementById('local_trabalho').value,
                email: document.getElementById('email').value,
                tipo_servico: document.getElementById('servico').value,
                tipo_atendimento: document.getElementById('tipo_atendimento').value,
                prioridade: document.getElementById('prioridade').value,
                data_agendamento: document.getElementById('data').value,
                hora_inicio: document.getElementById('hora').value || null,
                status: 'agendado',
                created_by: user.id
            };

            if (payload.hora_inicio) {
                const now = new Date();
                const [year, month, day] = payload.data_agendamento.split('-').map(Number);
                const [hours, minutes] = payload.hora_inicio.split(':').map(Number);
                const selectedDate = new Date(year, month - 1, day, hours, minutes);

                if (selectedDate < now) {
                    window.SAS.utils.modal.alert('Horário Inválido', 'Não é possível realizar agendamentos para horários que já passaram.', 'danger');
                    return;
                }
            }

            const submitAppointment = async (data) => {
                try {
                    await window.SAS.base44.entities.Agendamento.create(data);
                    window.SAS.utils.notify('success', 'Agendamento realizado com sucesso!');
                    form.reset();
                    updateTimeSlots();
                } catch (err) {
                    console.error('Submit Error:', err);
                    const errorData = err.data || {};
                    const errorMessage = err.message || '';

                    if (errorData.code === 'DUPLICATE_APPOINTMENT' || errorMessage.includes('Duplicate appointment')) {
                        window.SAS.utils.modal.confirm('Agendamento Duplicado', 'Já existe um agendamento para este servidor nesta data. Deseja agendar mesmo assim?', async () => {
                            data.force_duplicate = true;
                            await submitAppointment(data);
                        });
                    } else if (errorData.code === 'SLOT_CONFLICT' || errorMessage.includes('Slot conflict')) {
                        window.SAS.utils.modal.alert('Horário Ocupado', 'Este horário já está ocupado. Por favor, escolha outro horário.', 'danger');
                    } else {
                        window.SAS.utils.modal.alert('Erro', 'Erro ao realizar agendamento: ' + errorMessage, 'danger');
                    }
                }
            };

            await submitAppointment(payload);
        });
    </script>
</body>

</html>