<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimento - SAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sonner@1.4.0/dist/sonner.js"></script>
</head>

<body>
    <div id="app"></div>
    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/layout.js"></script>
    <script>
        const user = window.SAS.utils.checkAuth();
        window.SAS.layout.renderLayout('Atendimento');
        const content = document.getElementById('page-content');
        let currentGuiche = localStorage.getItem('sas_guiche') || '1';
        let currentQueueTab = 'Presencial';

        content.innerHTML = `
            <div class="flex flex-col items-center justify-center mb-6 animate-fade-in">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="headset" class="w-8 h-8 text-blue-700"></i>
                    <h1 class="text-3xl font-bold text-blue-700">Atendimentos</h1>
                </div>
                <div class="flex justify-center items-center">
                    <div class="h-1.5 w-32 bg-gradient-to-r from-blue-600 via-yellow-400 to-red-500 rounded-full"></div>
                </div>
            </div>

            <div class="flex justify-center items-center gap-4 mb-6">
                <div class="bg-blue-800 text-white px-8 py-2 rounded-lg font-bold text-xl shadow-lg">
                    Guich√™ <span id="guicheDisplay">${currentGuiche}</span>
                </div>
                <button id="alterarGuicheBtn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center gap-2 shadow-sm">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    Alterar
                </button>
                <button id="statusToggleBtn" class="bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-lg font-bold hover:bg-green-200 transition-all flex items-center gap-2 shadow-sm">
                    <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                    <span>Online</span>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto mb-8">
                <div class="bg-blue-50 border-2 border-blue-400 rounded-xl p-6 text-center shadow-sm">
                    <div class="text-4xl font-bold text-blue-800 mb-1" id="totalAgendados">0</div>
                    <div class="text-blue-600 font-medium">Agendados para hoje</div>
                </div>
                <div class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-6 text-center shadow-sm">
                    <div class="text-4xl font-bold text-yellow-800 mb-1" id="totalAguardando">0</div>
                    <div class="text-yellow-600 font-medium">Pessoas aguardando</div>
                </div>
            </div>

            <div id="mainArea" class="max-w-5xl mx-auto space-y-8">
                <div id="activeCallSection" class="hidden"></div>

                <div id="queueSection" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-800">Fila de Espera</h2>
                            <div class="flex bg-slate-100 p-1 rounded-lg">
                                <button onclick="setQueueTab('Presencial')" id="tabPresencial" class="px-4 py-1.5 rounded-md text-sm font-bold transition-all bg-white text-blue-700 shadow-sm">Presencial</button>
                                <button onclick="setQueueTab('WhatsApp')" id="tabWhatsApp" class="px-4 py-1.5 rounded-md text-sm font-bold transition-all text-slate-500 hover:text-slate-700">WhatsApp</button>
                            </div>
                        </div>
                        <button id="chamarProximoBtn" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition-all flex items-center gap-2">
                            <i data-lucide="megaphone" class="w-5 h-5"></i>
                            Chamar Pr√≥ximo
                        </button>
                    </div>
                    <div id="queueList" class="space-y-2"></div>
                </div>

                <div id="arrivalsSection" class="bg-white rounded-xl shadow-sm border border-blue-200 p-6">
                    <h2 class="text-xl font-bold text-blue-700 mb-4">Agendamentos de Hoje - Confirmar Chegada</h2>
                    <div id="arrivalsList" class="space-y-2"></div>
                </div>
            </div>

            <!-- Transfer Modal -->
            <div id="transferModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md animate-fade-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="arrow-right-left" class="w-5 h-5 text-blue-600"></i>
                        Transferir Atendimento
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Selecione o Atendente</label>
                            <select id="transferUserSelect" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="">Carregando usu√°rios...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Motivo da Transfer√™ncia</label>
                            <textarea id="transferObs" class="w-full border border-gray-300 rounded-lg p-3 h-24 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Explique o motivo da transfer√™ncia..."></textarea>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeTransferModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-200 transition-colors">Cancelar</button>
                            <button onclick="confirmTransfer()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">Confirmar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Modal -->
            <div id="statusModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md animate-fade-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Alterar Status</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Novo Status</label>
                            <select id="newStatusSelect" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="disponivel">Online (Dispon√≠vel)</option>
                                <option value="pausa">Pausa</option>
                            </select>
                        </div>
                        <div id="statusReasonDiv" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Motivo da Pausa</label>
                            <textarea id="statusReason" class="w-full border border-gray-300 rounded-lg p-3 h-24 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Ex: Almo√ßo, Banheiro..."></textarea>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeStatusModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-200 transition-colors">Cancelar</button>
                            <button onclick="confirmStatusChange()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">Confirmar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guiche Modal -->
            <div id="guicheModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm animate-fade-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Alterar Guich√™</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Guich√™</label>
                            <input type="text" id="newGuicheInput" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: 01">
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeGuicheModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-200 transition-colors">Cancelar</button>
                            <button onclick="confirmGuicheChange()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        lucide.createIcons();

        const guicheDisplay = document.getElementById('guicheDisplay');
        const alterarGuicheBtn = document.getElementById('alterarGuicheBtn');
        const statusToggleBtn = document.getElementById('statusToggleBtn');
        const activeCallSection = document.getElementById('activeCallSection');
        const queueSection = document.getElementById('queueSection');
        const arrivalsSection = document.getElementById('arrivalsSection');
        const queueList = document.getElementById('queueList');
        const arrivalsList = document.getElementById('arrivalsList');
        const chamarBtn = document.getElementById('chamarProximoBtn');
        const totalAgendadosEl = document.getElementById('totalAgendados');
        const totalAguardandoEl = document.getElementById('totalAguardando');

        // Modals
        const statusModal = document.getElementById('statusModal');
        const newStatusSelect = document.getElementById('newStatusSelect');
        const statusReasonDiv = document.getElementById('statusReasonDiv');
        const statusReason = document.getElementById('statusReason');
        const guicheModal = document.getElementById('guicheModal');
        const newGuicheInput = document.getElementById('newGuicheInput');

        let currentActiveItem = null;

        window.setQueueTab = (tab) => {
            currentQueueTab = tab;
            const tabP = document.getElementById('tabPresencial');
            const tabW = document.getElementById('tabWhatsApp');
            if (tab === 'Presencial') {
                tabP.className = 'px-4 py-1.5 rounded-md text-sm font-bold transition-all bg-white text-blue-700 shadow-sm';
                tabW.className = 'px-4 py-1.5 rounded-md text-sm font-bold transition-all text-slate-500 hover:text-slate-700';
            } else {
                tabP.className = 'px-4 py-1.5 rounded-md text-sm font-bold transition-all text-slate-500 hover:text-slate-700';
                tabW.className = 'px-4 py-1.5 rounded-md text-sm font-bold transition-all bg-green-100 text-green-700 shadow-sm';
            }
            loadData();
        };

        window.manualCall = async (id) => {
            if (currentStatus === 'pausa') {
                window.SAS.utils.notify('warning', 'Voc√™ est√° em pausa. Fique online para chamar o servidor.');
                return;
            }
            if (currentActiveItem) {
                window.SAS.utils.notify('warning', 'Voc√™ j√° tem um atendimento ativo. Encerre-o antes de chamar outro.');
                return;
            }
            window.SAS.utils.modal.confirm(
                'Chamar Servidor',
                'Deseja chamar este servidor agora?',
                async () => {
                    try {
                        await window.SAS.base44.entities.Agendamento.update(id, {
                            status: 'pendente',
                            atendente_id: user.id,
                            guiche: currentGuiche
                        });
                        loadData();
                        window.SAS.utils.notify('success', 'Chamando servidor...');
                    } catch (e) {
                        console.error(e);
                        window.SAS.utils.notify('error', 'Erro ao chamar servidor.');
                    }
                }
            );
        };

        // Guiche Logic
        alterarGuicheBtn.addEventListener('click', () => {
            newGuicheInput.value = currentGuiche;
            guicheModal.classList.remove('hidden');
        });

        window.closeGuicheModal = () => {
            guicheModal.classList.add('hidden');
        };

        window.confirmGuicheChange = () => {
            const newGuiche = newGuicheInput.value;
            if (newGuiche && newGuiche.trim() !== '') {
                currentGuiche = newGuiche.trim();
                localStorage.setItem('sas_guiche', currentGuiche);
                guicheDisplay.textContent = currentGuiche;
                window.SAS.utils.notify('success', `Guich√™ alterado para ${currentGuiche}`);
                closeGuicheModal();
            }
        };

        // Status Logic
        let currentStatus = 'disponivel';
        const updateStatusUI = (status, motivo = null) => {
            currentStatus = status;
            if (status === 'pausa') {
                statusToggleBtn.className = 'bg-red-100 text-red-700 border border-red-200 px-4 py-2 rounded-lg font-bold hover:bg-red-200 transition-all flex items-center gap-2 shadow-sm';
                statusToggleBtn.innerHTML = `<div class="w-3 h-3 rounded-full bg-red-500"></div><span>Pausa</span>`;
                statusToggleBtn.title = motivo || 'Em Pausa';
            } else {
                statusToggleBtn.className = 'bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-lg font-bold hover:bg-green-200 transition-all flex items-center gap-2 shadow-sm';
                statusToggleBtn.innerHTML = `<div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div><span>Online</span>`;
                statusToggleBtn.title = 'Online e dispon√≠vel';
            }
        };

        const fetchStatus = async () => {
            try {
                const response = await fetch('/api/usuarios/online');
                const onlineUsers = await response.json();
                const me = onlineUsers.find(u => u.id === user.id);
                if (me && me.status_atendimento) {
                    updateStatusUI(me.status_atendimento, me.motivo_pausa);
                }
            } catch (e) {
                console.error('Error fetching status:', e);
            }
        };

        statusToggleBtn.addEventListener('click', () => {
            // Open Modal
            newStatusSelect.value = currentStatus === 'pausa' ? 'pausa' : 'disponivel';
            toggleReasonField();
            statusModal.classList.remove('hidden');
        });

        newStatusSelect.addEventListener('change', () => {
            toggleReasonField();
        });

        function toggleReasonField() {
            if (newStatusSelect.value === 'pausa') {
                statusReasonDiv.classList.remove('hidden');
            } else {
                statusReasonDiv.classList.add('hidden');
            }
        }

        window.closeStatusModal = () => {
            statusModal.classList.add('hidden');
        };

        window.confirmStatusChange = async () => {
            const newStatus = newStatusSelect.value;
            let motivo = null;
            if (newStatus === 'pausa') {
                motivo = statusReason.value;
                if (!motivo.trim()) motivo = 'Pausa';
            }

            updateStatusUI(newStatus, motivo);
            try {
                const response = await fetch(`/api/usuarios/${user.id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, motivo: motivo })
                });
                if (!response.ok) throw new Error('Failed to update status');
                window.SAS.utils.notify('success', newStatus === 'pausa' ? 'Status definido como Pausa' : 'Status definido como Online');
                closeStatusModal();
            } catch (e) {
                console.error(e);
                updateStatusUI(currentStatus === 'disponivel' ? 'pausa' : 'disponivel'); // Revert
                window.SAS.utils.notify('error', 'Erro ao atualizar status');
            }
        };

        fetchStatus();

        const loadData = async () => {
            const all = await window.SAS.base44.entities.Agendamento.list();
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = all.filter(a => a.data_agendamento === today);
            totalAgendadosEl.textContent = todayAppointments.length;

            const arrivals = todayAppointments.filter(a => a.status === 'agendado').sort((a, b) => {
                const timeA = a.hora_inicio || '23:59';
                const timeB = b.hora_inicio || '23:59';
                return timeA.localeCompare(timeB);
            });

            const queue = todayAppointments.filter(a =>
                a.status === 'chegou' &&
                (a.tipo_atendimento === currentQueueTab || (!a.tipo_atendimento && currentQueueTab === 'Presencial'))
            ).sort((a, b) => {
                if (a.prioridade === 'Urgente' && b.prioridade !== 'Urgente') return -1;
                if (a.prioridade !== 'Urgente' && b.prioridade === 'Urgente') return 1;
                const timeA = a.hora_inicio || '00:00';
                const timeB = b.hora_inicio || '00:00';
                return timeA.localeCompare(timeB);
            });

            const active = todayAppointments.find(a =>
                (a.status === 'pendente' || a.status === 'em_andamento') &&
                a.atendente_id === user.id
            );

            totalAguardandoEl.textContent = queue.length;
            renderArrivals(arrivals);
            renderQueue(queue);
            renderActiveCall(active);
        };

        const renderArrivals = (items) => {
            arrivalsList.innerHTML = '';
            if (items.length === 0) {
                arrivalsList.innerHTML = '<p class="text-gray-400 italic">Nenhum agendamento pendente de chegada.</p>';
                return;
            }
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-4 border border-gray-100 rounded-lg hover:bg-gray-50';
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800">${item.nome_completo}</div>
                        <div class="text-sm text-gray-500">${item.hora_inicio || 'Sem hor√°rio'} - ${item.tipo_servico}</div>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="confirmArrival('${item.id}')" class="bg-green-600 text-white px-4 py-1.5 rounded font-bold text-sm hover:bg-green-700 flex items-center gap-1">
                            <i data-lucide="check" class="w-4 h-4"></i> Confirmar Chegada
                        </button>
                        <button onclick="markNoShow('${item.id}')" class="bg-red-100 text-red-600 px-4 py-1.5 rounded font-bold text-sm hover:bg-red-200">
                            N√£o Compareceu
                        </button>
                    </div>
                `;
                arrivalsList.appendChild(div);
            });
            lucide.createIcons();
        };

        const renderQueue = (items) => {
            queueSection.classList.remove('hidden');
            queueList.innerHTML = '';
            if (items.length === 0) {
                queueList.innerHTML = `
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-yellow-800 flex justify-between items-center">
                        <span>Ningu√©m aguardando na fila.</span>
                    </div>
                `;
                return;
            }
            items.forEach(item => {
                const isUrgent = item.prioridade === 'Urgente';
                const bgClass = isUrgent ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200';
                const textClass = isUrgent ? 'text-red-800' : 'text-green-800';
                const badge = isUrgent ? '<span class="bg-red-200 text-red-800 text-xs px-2 py-0.5 rounded-full font-bold">URGENTE</span>' : '';

                const div = document.createElement('div');
                div.className = `${bgClass} border p-4 rounded-lg flex justify-between items-center`;
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold ${textClass} text-lg">${item.nome_completo} ${badge}</div>
                        <div class="text-sm ${textClass} opacity-80">${item.tipo_servico}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden md:block">
                            <div class="font-bold ${textClass}">Aguardando</div>
                            <div class="text-xs ${textClass} opacity-80">Prioridade: ${item.prioridade}</div>
                        </div>
                        <button onclick="manualCall('${item.id}')" class="bg-white border border-slate-200 hover:bg-blue-50 text-blue-700 p-2 rounded-lg shadow-sm transition-all" title="Chamar Agora">
                            <i data-lucide="megaphone" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                queueList.appendChild(div);
            });
            lucide.createIcons();
        };

        const renderActiveCall = (item) => {
            if (currentActiveItem && item && currentActiveItem.id === item.id && currentActiveItem.status === item.status) return;
            currentActiveItem = item;
            if (!item) {
                activeCallSection.classList.add('hidden');
                queueSection.classList.remove('hidden');
                arrivalsSection.classList.remove('hidden');
                return;
            }
            activeCallSection.classList.remove('hidden');
            activeCallSection.innerHTML = '';
            if (item.status === 'pendente') {
                activeCallSection.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg border-2 border-blue-500 p-8 animate-fade-in relative">
                        ${item.observacao_transferencia ? `
                            <div class="mb-4 bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <div class="text-xs font-bold text-blue-800 uppercase mb-1">Motivo da Transfer√™ncia</div>
                                <p class="text-blue-900 text-sm">${item.observacao_transferencia}</p>
                            </div>
                        ` : ''}
                        <div class="mb-6">
                            <h2 class="text-3xl font-bold text-blue-800 mb-1">${item.nome_completo}</h2>
                            <div class="text-gray-500 text-lg">${item.tipo_servico}</div>
                            <span class="bg-gray-600 text-white px-3 py-1 rounded-full text-sm font-bold mt-2 inline-block">Prioridade: ${item.prioridade}</span>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="startService('${item.id}')" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold text-lg flex items-center gap-2 transition-all">
                                <i data-lucide="play" class="w-5 h-5"></i> Iniciar Atendimento
                            </button>
                            <button onclick="cancelService('${item.id}')" class="bg-white border border-gray-300 text-gray-600 px-6 py-3 rounded-lg font-bold text-lg hover:bg-gray-50 flex items-center gap-2">
                                <i data-lucide="x" class="w-5 h-5"></i> Cancelar
                            </button>
                        </div>
                    </div>
                `;
            } else if (item.status === 'em_andamento') {
                activeCallSection.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg border-2 border-blue-500 p-8 animate-fade-in relative">
                        ${item.observacao_transferencia ? `
                            <div class="mb-4 bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <div class="text-xs font-bold text-blue-800 uppercase mb-1">Motivo da Transfer√™ncia</div>
                                <p class="text-blue-900 text-sm">${item.observacao_transferencia}</p>
                            </div>
                        ` : ''}
                        <div class="mb-6 border-b pb-4">
                            <h2 class="text-3xl font-bold text-blue-800 mb-1">${item.nome_completo}</h2>
                            <div class="text-gray-500 text-lg">${item.tipo_servico}</div>
                            <span class="bg-gray-600 text-white px-3 py-1 rounded-full text-sm font-bold mt-2 inline-block">Prioridade: ${item.prioridade}</span>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-blue-700 font-bold mb-2">Observa√ß√£o 1 - Problema relatado pelo cliente</label>
                                <textarea id="obs1" class="w-full border border-gray-300 rounded-lg p-3 h-24 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Descreva o problema relatado..."></textarea>
                            </div>
                            <div>
                                <label class="block text-blue-700 font-bold mb-2">Observa√ß√£o 2 - Resposta/Solu√ß√£o dada pelo atendente</label>
                                <textarea id="obs2" class="w-full border border-gray-300 rounded-lg p-3 h-24 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Descreva a solu√ß√£o fornecida..."></textarea>
                            </div>
                            <button onclick="finishService('${item.id}')" class="w-full bg-gray-300 hover:bg-blue-600 hover:text-white text-gray-700 font-bold py-4 rounded-lg transition-all flex justify-center items-center gap-2 mt-4" id="finishBtn">
                                <i data-lucide="check-circle" class="w-5 h-5"></i> Encerrar Atendimento
                            </button>
                            <button onclick="openTransferModal('${item.id}')" class="w-full bg-white border-2 border-blue-100 hover:bg-blue-50 text-blue-700 font-bold py-3 rounded-lg transition-all flex justify-center items-center gap-2">
                                <i data-lucide="arrow-right-left" class="w-5 h-5"></i> Transferir Atendimento
                            </button>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        };

        window.confirmArrival = (id) => {
            window.SAS.utils.modal.confirm(
                'Confirmar Chegada',
                'Deseja confirmar a chegada deste cidad√£o?',
                async () => {
                    try {
                        await window.SAS.base44.entities.Agendamento.update(id, { status: 'chegou' });
                        loadData();
                        window.SAS.utils.notify('success', 'Chegada confirmada!');
                    } catch (err) {
                        console.error(err);
                        window.SAS.utils.notify('error', 'Erro ao confirmar chegada.');
                    }
                }
            );
        };

        window.markNoShow = (id) => {
            window.SAS.utils.modal.confirm(
                'N√£o Compareceu',
                'Confirmar que o cidad√£o N√ÉO compareceu? Esta a√ß√£o remover√° o agendamento da lista de hoje.',
                async () => {
                    try {
                        await window.SAS.base44.entities.Agendamento.update(id, { status: 'nao_compareceu' });
                        loadData();
                        window.SAS.utils.notify('warning', 'Marcado como n√£o compareceu.');
                    } catch (err) {
                        console.error(err);
                        window.SAS.utils.notify('error', 'Erro ao atualizar status.');
                    }
                },
                'danger'
            );
        };

        window.startService = async (id) => {
            await window.SAS.base44.entities.Agendamento.update(id, { status: 'em_andamento' });
            loadData();
        };

        window.cancelService = async (id) => {
            window.SAS.utils.modal.confirm(
                'Cancelar Chamado',
                'Deseja cancelar este chamado e devolver para a fila?',
                async () => {
                    await window.SAS.base44.entities.Agendamento.update(id, { status: 'chegou', atendente_id: null, guiche: null });
                    loadData();
                },
                'danger'
            );
        };

        window.finishService = async (id) => {
            const obs1 = document.getElementById('obs1').value;
            const obs2 = document.getElementById('obs2').value;
            if (!obs1.trim() || !obs2.trim()) {
                window.SAS.utils.notify('warning', '√â preciso preencher as duas observa√ß√µes para encerrar.');
                return;
            }
            try {
                await window.SAS.base44.entities.Agendamento.update(id, {
                    status: 'concluido',
                    atendente_id: user.id,
                    observacao_problema: obs1,
                    observacao_solucao: obs2
                });
                window.SAS.utils.notify('success', 'Atendimento encerrado com sucesso!');
                loadData();
            } catch (e) {
                window.SAS.utils.notify('error', 'Erro ao encerrar atendimento.');
            }
        };

        const transferModal = document.getElementById('transferModal');
        const transferUserSelect = document.getElementById('transferUserSelect');
        const transferObs = document.getElementById('transferObs');
        let itemToTransferId = null;

        window.openTransferModal = async (id) => {
            itemToTransferId = id;
            transferObs.value = '';

            try {
                const [users, onlineUsers] = await Promise.all([
                    window.SAS.base44.entities.SystemUser.list(),
                    fetch('/api/usuarios/online').then(res => res.json())
                ]);

                const activeUsers = users.filter(u => u.id !== user.id && u.situacao === 'ativo');
                transferUserSelect.innerHTML = '<option value="">Selecione um atendente...</option>';

                activeUsers.forEach(u => {
                    const onlineInfo = onlineUsers.find(ou => ou.id === u.id);
                    const isOnline = !!onlineInfo;
                    const statusText = isOnline ? (onlineInfo.status_atendimento === 'pausa' ? 'Em Pausa' : 'Online') : 'Offline';
                    const statusColor = isOnline ? (onlineInfo.status_atendimento === 'pausa' ? 'üü†' : 'üü¢') : '‚ö™';

                    const option = document.createElement('option');
                    option.value = u.id;
                    option.textContent = `${u.nome_completo || u.usuario} (Guich√™ ${u.guiche_atual || '?'}) - ${statusColor} ${statusText}`;
                    transferUserSelect.appendChild(option);
                });
                transferModal.classList.remove('hidden');
            } catch (e) {
                console.error('Error loading users for transfer:', e);
                window.SAS.utils.notify('error', 'Erro ao carregar lista de atendentes.');
            }
        };

        window.closeTransferModal = () => {
            transferModal.classList.add('hidden');
            itemToTransferId = null;
        };

        window.confirmTransfer = async () => {
            if (!itemToTransferId) return;
            const targetUserId = transferUserSelect.value;
            const obs = transferObs.value;
            if (!targetUserId) {
                window.SAS.utils.notify('warning', 'Selecione um atendente para transferir.');
                return;
            }
            if (!obs.trim()) {
                window.SAS.utils.notify('warning', 'Por favor, informe o motivo da transfer√™ncia.');
                return;
            }

            window.SAS.utils.modal.confirm(
                'Transferir Atendimento',
                'Tem certeza que deseja transferir este atendimento?',
                async () => {
                    try {
                        await window.SAS.base44.entities.Agendamento.update(itemToTransferId, {
                            status: 'pendente',
                            atendente_id: targetUserId,
                            observacao_transferencia: obs
                        });
                        window.SAS.utils.notify('success', 'Atendimento transferido com sucesso!');
                        closeTransferModal();
                        loadData();
                    } catch (e) {
                        window.SAS.utils.notify('error', 'Erro ao transferir atendimento.');
                    }
                }
            );
        };

        chamarBtn.addEventListener('click', async () => {
            if (currentStatus === 'pausa') {
                window.SAS.utils.notify('warning', 'Voc√™ est√° em pausa. Fique online para chamar o pr√≥ximo.');
                return;
            }
            if (currentActiveItem) {
                window.SAS.utils.notify('warning', 'Voc√™ j√° tem um atendimento ativo. Encerre-o antes de chamar o pr√≥ximo.');
                return;
            }
            const all = await window.SAS.base44.entities.Agendamento.list();
            const today = new Date().toISOString().split('T')[0];
            const queue = all.filter(a =>
                a.data_agendamento === today &&
                a.status === 'chegou' &&
                (a.tipo_atendimento === currentQueueTab || (!a.tipo_atendimento && currentQueueTab === 'Presencial'))
            ).sort((a, b) => {
                if (a.prioridade === 'Urgente' && b.prioridade !== 'Urgente') return -1;
                if (a.prioridade !== 'Urgente' && b.prioridade === 'Urgente') return 1;
                const timeA = a.hora_inicio || '00:00';
                const timeB = b.hora_inicio || '00:00';
                return timeA.localeCompare(timeB);
            });
            if (queue.length === 0) {
                window.SAS.utils.notify('info', 'N√£o h√° ningu√©m aguardando na fila.');
                return;
            }
            const next = queue[0];
            try {
                await window.SAS.base44.entities.Agendamento.update(next.id, {
                    status: 'pendente',
                    atendente_id: user.id,
                    guiche: currentGuiche
                });
                loadData();
                window.SAS.utils.notify('success', 'Chamando pr√≥ximo da fila...');
            } catch (e) {
                window.SAS.utils.notify('error', 'Erro ao chamar pr√≥ximo.');
            }
        });

        loadData();
        setInterval(loadData, 3000);
    </script>
</body>

</html>