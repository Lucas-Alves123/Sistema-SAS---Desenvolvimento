<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários - SAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="app"></div>

    <!-- Modal Usuário -->
    <div id="modalUsuario" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl">
            <h3 id="modalTitle" class="text-lg font-bold mb-4 text-blue-700">Novo Usuário</h3>

            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId">

                <div class="space-y-2">
                    <label class="text-sm font-medium">Nome Completo</label>
                    <input type="text" id="nomeCompleto" class="w-full border p-2 rounded" required>
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium">CPF</label>
                    <input type="text" id="cpf" class="w-full border p-2 rounded" maxlength="14">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium">E-mail</label>
                    <input type="email" id="email" class="w-full border p-2 rounded">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium">Tipo</label>
                    <select id="tipo" class="w-full border p-2 rounded">
                        <option value="usuario">Usuário</option>
                        <option value="adm">Administrador</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium">Senha</label>
                    <input type="password" id="senha" class="w-full border p-2 rounded">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium">Confirmar Senha</label>
                    <input type="password" id="confirmSenha" class="w-full border p-2 rounded">
                </div>

                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" id="cancelBtn"
                        class="border px-4 py-2 rounded hover:bg-slate-50">Cancelar</button>
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/layout.js"></script>

    <script>
        const user = window.SAS.utils.checkAuth();
        window.SAS.layout.renderLayout('Usuários');

        const content = document.getElementById('page-content');

        content.innerHTML = `
            <div class="flex flex-col items-center gap-2 mb-8 animate-fade-in">
                <div class="flex items-center gap-3">
                    <i data-lucide="users" class="w-8 h-8 text-blue-700"></i>
                    <h1 class="text-3xl font-bold text-blue-700">Gerenciar Usuários</h1>
                </div>
                <div class="flex gap-1">
                    <div class="w-16 h-2 bg-blue-600 rounded-full"></div>
                    <div class="w-4 h-2 bg-yellow-400 rounded-full"></div>
                    <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-100 p-6 max-w-6xl mx-auto">
                <!-- Toolbar -->
                <div class="flex flex-wrap gap-4 mb-6 justify-between items-center">
                    <div class="relative flex-1 min-w-[200px]">
                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input id="searchInput" type="text" placeholder="Pesquisar por nome..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    ${user.tipo === 'adm' ? `
                    <button id="newUserBtn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg flex items-center gap-2 font-medium transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i> Novo Usuário
                    </button>
                    ` : ''}
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-blue-600 text-white">
                                <th class="p-3 rounded-tl-lg">Nome</th>
                                <th class="p-3">Usuário</th>
                                <th class="p-3">E-mail</th>
                                <th class="p-3">Tipo</th>
                                <th class="p-3">Situação</th>
                                <th class="p-3 rounded-tr-lg text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="divide-y divide-slate-100">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        lucide.createIcons();

        // Logic
        const modalUsuario = document.getElementById('modalUsuario');
        const userForm = document.getElementById('userForm');
        const searchInput = document.getElementById('searchInput');
        const newUserBtn = document.getElementById('newUserBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const userTableBody = document.getElementById('userTableBody');
        const modalTitle = document.getElementById('modalTitle');

        let usersList = [];

        const loadUsers = async () => {
            usersList = await window.SAS.base44.entities.SystemUser.list();
            renderTable(usersList);
        };

        const renderTable = (data) => {
            userTableBody.innerHTML = '';
            if (data.length === 0) {
                userTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhum usuário encontrado.</td></tr>';
                return;
            }

            data.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors';

                const situacaoClass = u.situacao === 'ativo'
                    ? 'bg-green-100 text-green-800'
                    : 'bg-red-100 text-red-800';

                // Permission Logic
                let actionsHTML = '';

                // Only Admins can see actions
                if (user.tipo === 'adm') {
                    // Admins can only edit/delete 'usuario' type, NOT other 'adm'
                    // Exception: Admin can edit themselves (optional, but usually safer to block or allow limited edit)
                    // User request: "adm podem controlar as ações de quem é usuario não de outros adm"

                    if (u.tipo === 'usuario') {
                        actionsHTML = `
                            <div class="flex justify-end gap-2">
                                <button class="text-yellow-600 hover:bg-yellow-50 p-1 rounded edit-btn" data-id="${u.id}">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button class="text-red-600 hover:bg-red-50 p-1 rounded delete-btn" data-id="${u.id}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        actionsHTML = '<span class="text-gray-400 text-xs italic">Restrito</span>';
                    }
                } else {
                    actionsHTML = '<span class="text-gray-400 text-xs italic">Sem permissão</span>';
                }

                // Toggle Status Logic (also restricted)
                let statusHTML = '';
                if (user.tipo === 'adm' && u.tipo === 'usuario') {
                    statusHTML = `
                        <span class="cursor-pointer px-2 py-1 rounded-full text-xs font-medium ${situacaoClass} toggle-status" data-id="${u.id}">
                            ${u.situacao === 'ativo' ? 'Ativo' : 'Inativo'}
                        </span>
                    `;
                } else {
                    statusHTML = `
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${situacaoClass}">
                            ${u.situacao === 'ativo' ? 'Ativo' : 'Inativo'}
                        </span>
                    `;
                }

                tr.innerHTML = `
                    <td class="p-3 font-medium">${u.nome_completo}</td>
                    <td class="p-3 text-gray-600">${u.usuario}</td>
                    <td class="p-3 text-gray-600">${u.email || '-'}</td>
                    <td class="p-3"><span class="bg-slate-100 px-2 py-1 rounded text-xs uppercase font-bold text-slate-600">${u.tipo}</span></td>
                    <td class="p-3">${statusHTML}</td>
                    <td class="p-3 text-right">${actionsHTML}</td>
                `;
                userTableBody.appendChild(tr);
            });
            lucide.createIcons();

            // Attach Events
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => openEditModal(btn.dataset.id));
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteUser(btn.dataset.id));
            });
            document.querySelectorAll('.toggle-status').forEach(btn => {
                btn.addEventListener('click', () => toggleStatus(btn.dataset.id));
            });
        };

        // Search
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = usersList.filter(u =>
                u.nome_completo.toLowerCase().includes(term) ||
                u.usuario.toLowerCase().includes(term)
            );
            renderTable(filtered);
        });

        // Modal Actions
        if (newUserBtn) {
            newUserBtn.addEventListener('click', () => {
                userForm.reset();
                document.getElementById('userId').value = '';
                modalTitle.textContent = 'Novo Usuário';
                modalUsuario.classList.remove('hidden');
            });
        }

        cancelBtn.addEventListener('click', () => {
            modalUsuario.classList.add('hidden');
        });

        // Form Submit
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const nome = document.getElementById('nomeCompleto').value;
            const cpf = document.getElementById('cpf').value;
            const email = document.getElementById('email').value;
            const tipo = document.getElementById('tipo').value;
            const senha = document.getElementById('senha').value;
            const confirmSenha = document.getElementById('confirmSenha').value;

            // Password Validation
            if (senha && senha !== confirmSenha) {
                alert('As senhas não coincidem!');
                return;
            }

            const usuarioGerado = nome.toLowerCase().split(' ')[0] + '.' + (nome.toLowerCase().split(' ').pop() || '');

            const payload = {
                nome_completo: nome,
                cpf,
                email,
                tipo,
                usuario: usuarioGerado
            };

            if (senha) payload.senha = senha;

            try {
                if (id) {
                    await window.SAS.base44.entities.SystemUser.update(id, payload);
                } else {
                    if (!senha) {
                        alert('Senha é obrigatória para novos usuários.');
                        return;
                    }
                    payload.situacao = 'ativo';
                    await window.SAS.base44.entities.SystemUser.create(payload);
                }
                modalUsuario.classList.add('hidden');
                loadUsers();
            } catch (err) {
                alert('Erro ao salvar usuário.');
            }
        });

        // Actions
        const openEditModal = (id) => {
            const u = usersList.find(user => user.id === id);
            if (!u) return;

            document.getElementById('userId').value = u.id;
            document.getElementById('nomeCompleto').value = u.nome_completo;
            document.getElementById('cpf').value = u.cpf || '';
            document.getElementById('email').value = u.email || '';
            document.getElementById('tipo').value = u.tipo;
            document.getElementById('senha').value = ''; // Don't show password
            document.getElementById('confirmSenha').value = '';

            modalTitle.textContent = 'Editar Usuário';
            modalUsuario.classList.remove('hidden');
        };

        const deleteUser = async (id) => {
            if (id === user.id) {
                alert('Você não pode excluir seu próprio usuário.');
                return;
            }
            if (confirm('Tem certeza que deseja excluir este usuário?')) {
                await window.SAS.base44.entities.SystemUser.delete(id);
                loadUsers();
            }
        };

        const toggleStatus = async (id) => {
            const u = usersList.find(user => user.id === id);
            const novoStatus = u.situacao === 'ativo' ? 'inativo' : 'ativo';
            await window.SAS.base44.entities.SystemUser.update(id, { situacao: novoStatus });
            loadUsers();
        };

        // CPF Mask
        document.getElementById('cpf').addEventListener('input', (e) => {
            e.target.value = window.SAS.utils.formatCPF(e.target.value);
        });

        loadUsers();
    </script>
</body>

</html>